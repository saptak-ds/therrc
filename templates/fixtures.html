<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Fixtures & Results</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 font-sans">
    <!-- Main Header -->
    <header class="w-full bg-gray-800 py-8 text-center relative">
      <h1 class="text-white text-4xl font-semibold uppercase tracking-wider">
        THE RENDERED RIVALRY CUP
      </h1>
      <a
        href="/admin"
        class="absolute top-1/2 -translate-y-1/2 right-4 md:right-8 text-sm font-medium text-gray-300 bg-gray-700/50 px-4 py-2 rounded-lg hover:bg-gray-600/50 transition-colors"
      >
        Admin Panel
      </a>
    </header>

    <!-- Navigation Menu -->
    <nav class="bg-white shadow-md">
      <div class="container mx-auto px-4">
        <div class="flex justify-center -mb-px">
          <a
            href="/"
            class="py-4 px-6 block hover:text-blue-500 focus:outline-none text-gray-600"
            >HOME</a
          >
          <a
            href="/standings"
            class="py-4 px-6 block hover:text-blue-500 focus:outline-none text-gray-600"
            >STANDINGS</a
          >
          <a
            href="/fixtures"
            class="py-4 px-6 block hover:text-blue-500 focus:outline-none {% if active_page == 'fixtures' %}text-blue-500 border-b-2 font-semibold border-blue-500{% else %}text-gray-600{% endif %}"
            >FIXTURES</a
          >
          <a
            href="/reports"
            class="py-4 px-6 block hover:text-blue-500 focus:outline-none text-gray-600"
            >REPORTS</a
          >
          <a
            href="/about"
            class="py-4 px-6 block hover:text-blue-500 focus:outline-none text-gray-600"
            >ABOUT</a
          >
        </div>
      </div>
    </nav>

    <!-- Main Content Container -->
    <div class="w-full px-4 sm:px-6 lg:px-8 mt-8">
      <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <!-- Controls Area -->
        <div
          class="p-6 bg-gray-50 border-b border-gray-200 flex flex-wrap items-center justify-between gap-4"
        >
          <div class="flex items-center gap-4">
            <select
              id="tournament-select"
              class="bg-white border border-gray-300 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">-- Select a Tournament --</option>
            </select>
          </div>
          <a
            href="/"
            class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors duration-300"
            >Back to Home</a
          >
        </div>

        <!-- Report Title -->
        <div
          id="season-subtitle"
          class="text-center text-2xl font-bold text-white uppercase bg-gradient-to-r from-slate-700 to-slate-800 py-4 tracking-widest shadow-inner"
        >
          Select a season to view fixtures
        </div>

        <!-- Fixtures Content -->
        <main id="fixtures-content" class="p-6 md:p-8">
          <p class="text-gray-500 text-center col-span-full">
            Select a tournament from the dropdown to view its fixtures.
          </p>
        </main>
      </div>
    </div>

    <script>
      let currentTournamentData = null;

      function renderFixturesTable(fixtures) {
          const fixturesByStage = fixtures.reduce((acc, match) => {
              const stage = match.stage;
              const stageKey = (stage.includes('Group') || stage === 'League') ? 'League Stage' : stage;
              if (!acc[stageKey]) { acc[stageKey] = []; }
              acc[stageKey].push(match);
              return acc;
          }, {});

          const stageOrder = ['League Stage', 'Quarter-Final', 'Semi-Final', 'Final'];
          const stageStyles = {
              'League Stage':    { header: 'bg-gray-100 text-gray-800', row: 'bg-white' },
              'Quarter-Final': { header: 'bg-blue-100 text-blue-800 font-bold', row: 'bg-blue-50' },
              'Semi-Final':    { header: 'bg-indigo-100 text-indigo-800 font-bold', row: 'bg-indigo-50' },
              'Final':         { header: 'bg-amber-100 text-amber-800 font-bold', row: 'bg-amber-50' }
          };

          const winnerMap = {};
          (currentTournamentData.fixtures || []).forEach(match => {
              if (match.status === 'Played' && (match.stage === 'Quarter-Final' || match.stage === 'Semi-Final')) {
                  const placeholder = `Winner ${match.stage} ${match.round_in_stage}`;
                  let winnerName = (match.team1_pso !== null && match.team1_pso > match.team2_pso) ? match.team1_name : (match.team1_goals > match.team2_goals) ? match.team1_name : match.team2_name;
                  winnerMap[placeholder] = winnerName;
              }
          });

          let finalHtml = '<div class="space-y-6">';
          stageOrder.forEach(stageName => {
              if (fixturesByStage[stageName] && fixturesByStage[stageName].length > 0) {
                  const style = stageStyles[stageName];
                  const matches = fixturesByStage[stageName];
                  finalHtml += `<h4 class="text-lg font-semibold uppercase tracking-wider p-2 rounded-t-lg ${style.header}">${stageName}</h4>`;
                  let table = '<div class="overflow-hidden border-x border-b rounded-b-lg"><table class="w-full text-sm text-left text-gray-500"> <thead class="text-xs text-gray-700 uppercase bg-gray-50"> <tr> <th class="px-4 py-3">Match</th> <th class="px-4 py-3">Stage</th> <th class="px-4 py-3 text-right">Team 1</th> <th class="px-4 py-3 text-center">Score</th> <th class="px-4 py-3">Team 2</th> </tr> </thead> <tbody>';
                  matches.forEach(match => {
                      let score = '<span class="text-gray-400">vs</span>';
                      let team1Name = winnerMap[match.team1_name] || match.team1_name || 'TBD';
                      let team2Name = winnerMap[match.team2_name] || match.team2_name || 'TBD';
                      let resultSummary = '';
                      let detailedStageName = match.stage === 'Quarter-Final' ? `QF ${match.round_in_stage}` : match.stage === 'Semi-Final' ? `SF ${match.round_in_stage}` : match.stage;
                      if (match.status === 'Played') {
                          score = `${match.team1_goals} - ${match.team2_goals}`;
                          if (match.team1_pso !== null) {
                              score += ` (${match.team1_pso}-${match.team2_pso} pens)`;
                              let winner = (match.team1_pso > match.team2_pso) ? team1Name : team2Name;
                              resultSummary = `<span class="text-xs text-gray-500">${winner} won on penalties</span>`;
                              if(match.team1_pso > match.team2_pso) team1Name = `<span class="font-bold text-green-600">${team1Name}</span>`; else team2Name = `<span class="font-bold text-green-600">${team2Name}</span>`;
                          } else {
                              if (match.team1_goals > match.team2_goals) {
                                  let diff = match.team1_goals - match.team2_goals;
                                  resultSummary = `<span class="text-xs text-gray-500">${team1Name} won by ${diff} goal${diff > 1 ? 's' : ''}</span>`;
                                  team1Name = `<span class="font-bold text-green-600">${team1Name}</span>`;
                              } else if (match.team2_goals > match.team1_goals) {
                                  let diff = match.team2_goals - match.team1_goals;
                                  resultSummary = `<span class="text-xs text-gray-500">${team2Name} won by ${diff} goal${diff > 1 ? 's' : ''}</span>`;
                                  team2Name = `<span class="font-bold text-green-600">${team2Name}</span>`;
                              } else {
                                  resultSummary = `<span class="text-xs text-gray-500">Match Drawn</span>`;
                              }
                          }
                      }
                      table += `<tr class="${style.row} border-t hover:bg-gray-100 transition-colors">
                          <td class="px-4 py-3 text-gray-500">${match.display_no}</td>
                          <td class="px-4 py-3 text-gray-600 whitespace-nowrap">${detailedStageName}</td>
                          <td class="px-4 py-3 text-right font-medium">${team1Name}</td>
                          <td class="px-4 py-3 text-center"><div class="flex flex-col"><span class="font-bold text-lg">${score}</span>${resultSummary}</div></td>
                          <td class="px-4 py-3 font-medium">${team2Name}</td>
                      </tr>`;
                  });
                  finalHtml += table + '</tbody></table></div>';
              }
          });
          return finalHtml + '</div>';
      }

      function applyFixtureFilters() {
          if (!currentTournamentData) return;
          const filterType = document.getElementById('fixture-filter-type').value;
          const filterValue = document.getElementById('fixture-filter-value').value;
          let filteredFixtures = [];

          if (filterType === 'all') {
              filteredFixtures = currentTournamentData.fixtures;
          } else if (filterType === 'group' && filterValue) {
              filteredFixtures = currentTournamentData.fixtures.filter(m => m.stage === filterValue);
          } else if (filterType === 'team' && filterValue) {
              filteredFixtures = currentTournamentData.fixtures.filter(m => m.team1_name === filterValue || m.team2_name === filterValue);
          } else if (filterType === 'knockouts') {
              filteredFixtures = currentTournamentData.fixtures.filter(m => !m.stage.includes('Group') && !m.stage.includes('League'));
          } else {
              filteredFixtures = currentTournamentData.fixtures;
          }

          const fixturesContainer = document.getElementById('fixtures-display-area');
          if(fixturesContainer) {
              let html = renderFixturesTable(filteredFixtures);
              if (!filteredFixtures || filteredFixtures.length === 0) {
                  html = '<p class="text-gray-500 text-center col-span-full py-8">No fixtures match the selected filter.</p>';
              }
              fixturesContainer.innerHTML = html;
          }
      }

      function renderPage(data) {
          currentTournamentData = data;
          const fixturesContent = document.getElementById('fixtures-content');
          const seasonSubtitle = document.getElementById('season-subtitle');
          seasonSubtitle.textContent = `Season ${data.season_number} Fixtures & Results`;

          let pageHtml = `<div class="flex justify-between items-center bg-gray-50 p-4 rounded-lg border mb-6">
              <h2 class="text-xl font-semibold text-gray-800">Filters</h2>
              <div class="flex items-center gap-2">
                  <select id="fixture-filter-type" class="text-sm bg-white border border-gray-300 rounded p-1 focus:outline-none">
                      <option value="all">All Fixtures</option>
                      <option value="group" id="group-filter-option">Group Wise</option>
                      <option value="team">Team Wise</option>
                      <option value="knockouts" id="knockout-filter-option">Knockouts</option>
                  </select>
                  <select id="fixture-filter-value" class="text-sm bg-white border border-gray-300 rounded p-1 focus:outline-none" style="display: none;"></select>
              </div>
          </div>
          <div id="fixtures-display-area"></div>`;
          fixturesContent.innerHTML = pageHtml;

          const filterTypeSelect = document.getElementById('fixture-filter-type');
          const filterValueSelect = document.getElementById('fixture-filter-value');
          const groupFilterOption = document.getElementById('group-filter-option');
          const knockoutFilterOption = document.getElementById('knockout-filter-option');

          const hasGroups = Object.keys(data.standings).length > 1;
          const hasKnockouts = data.fixtures.some(m => !m.stage.includes('Group') && !m.stage.includes('League'));
          groupFilterOption.style.display = hasGroups ? 'block' : 'none';
          knockoutFilterOption.style.display = hasKnockouts ? 'block' : 'none';

          filterTypeSelect.addEventListener('change', () => {
              const selectedType = filterTypeSelect.value;
              filterValueSelect.innerHTML = '';
              filterValueSelect.style.display = 'none';
              if (selectedType === 'group') {
                  filterValueSelect.style.display = 'block';
                  filterValueSelect.add(new Option('Select Group...', ''));
                  Object.keys(data.standings).forEach(groupName => {
                      filterValueSelect.add(new Option(`Group ${groupName}`, `Group ${groupName}`));
                  });
              } else if (selectedType === 'team') {
                  filterValueSelect.style.display = 'block';
                  filterValueSelect.add(new Option('Select Team...', ''));
                  const allTeams = Object.values(data.standings).flat().map(t => t.name).sort();
                  [...new Set(allTeams)].forEach(teamName => {
                      filterValueSelect.add(new Option(teamName, teamName));
                  });
              }
              applyFixtureFilters();
          });
          filterValueSelect.addEventListener('change', applyFixtureFilters);

          applyFixtureFilters();
      }

      window.onload = function() {
          const tournamentSelect = document.getElementById('tournament-select');
          const fixturesContent = document.getElementById('fixtures-content');
          const seasonSubtitle = document.getElementById('season-subtitle');

          fetch('/api/tournaments')
              .then(response => response.json())
              .then(tournaments => {
                  tournaments.forEach(tourney => {
                      tournamentSelect.add(new Option(`Season ${tourney.season_number} (Created: ${new Date(tourney.created_date).toLocaleDateString()})`, tourney.tournament_id));
                  });
                  try {
                      const preselectedId = {{ preselected_id|tojson }};
                      if (preselectedId) {
                          tournamentSelect.value = preselectedId;
                          tournamentSelect.dispatchEvent(new Event('change'));
                      }
                  } catch (e) { console.error("Could not process preselected ID.", e); }
              });

          tournamentSelect.addEventListener('change', function() {
              const tournamentId = this.value;
              const newUrl = tournamentId ? `/fixtures/${tournamentId}` : '/fixtures';
              window.history.pushState({path: newUrl}, '', newUrl);

              if (!tournamentId) {
                  fixturesContent.innerHTML = '<p class="text-gray-500 text-center col-span-full">Select a tournament from the dropdown.</p>';
                  seasonSubtitle.textContent = 'Select a season to view fixtures';
                  currentTournamentData = null;
                  return;
              }

              fixturesContent.innerHTML = '<div class="text-center col-span-full text-gray-500">Loading Fixtures...</div>';
              fetch(`/api/tournaments/${tournamentId}`)
                  .then(response => response.json())
                  .then(data => renderPage(data));
          });
      };
    </script>
  </body>
</html>
